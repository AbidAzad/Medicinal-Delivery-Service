<!DOCTYPE html>
<html lang="en">
  <head> 
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" type="text/css" href="../css/dynamic-size.css" >
    <link rel="stylesheet" type="text/css" href="../css/darkmode.css" >


    <title>DrugHub | Dashboard</title>

    <script src="../js/dynamicHeaderFooter.js"></script>

  </head>

  <body>
    <script src="../js/darkmode.js"></script>
    
    <div id="header"></div>


    <div class="container">
      <div id="sideMenu" class="sidebar">
        <a
          id="infoOption"
          class="active"
          href="#"
          onclick='swapDisplay("profile-info", "infoOption")'
          >Profile Information</a
        >
        <a id="orderOption"
          class=""
          href="#"
          onclick='swapDisplay("order-AND-prescription-info", "orderOption")'
          >Order/Prescription History</a>

        <a id="paymentOption"
          class=""
          href="#"
          onclick='swapDisplay("payment-info", "paymentOption")'
          >Payment Information</a>

        <a id="settingsOption"
          class=""
          href="#"
          onclick='swapDisplay("settings-info", "settingsOption")'
          >Settings</a>

          

        <a id ="loggingOut" onclick="logout()">Logout</a>
      </div>

      <div id="interface" class="interface-container"></div>

      <!---PROFILE INFORMATION-->
      <div id="profile-info" class="info-container">
        <section id="info" class="DrugFo">
          <image
            id="profile-pic"
            class="profile-pic"
            src="../images/profile.png"
          ></image>
          <h1 id="welcome-text">Welcome, Anonymous!</h1>

          <div class="row">
            <h2>Personal Information:</h2>
            <div class="col colDash">
              <h3>Full Name</h3>
              <p id="full-name">Some Random Full Name</p>
              <hr class="dashTable"/>

              <h3>Email</h3>
              <p id="email">randomassemail@random.com</p>
              <hr class="dashTable" />

              <h3>Address</h3>
              <p><a id="address">220 Poopoo Pl, Kailua, HI 96734</a> <i onclick ="addressChange()" class="fa fa-pencil fa-lg" style="margin-left: 10px; cursor:pointer;" ></i></p> 
              <hr class="dashTable"/>

              <h3>Phone</h3>
              <p ><a id="phone">666-420-6666</a><i onclick="phoneNumberChange()" class="fa fa-pencil fa-lg" style="margin-left: 10px; cursor: pointer;"></i></p>
            </div>

          </div>
        </section>
      </div>



      <!---ORDER INFORMATION-->
      <div id="order-AND-prescription-info" class="info-container">
        <section id="info" class="DrugFo">
          <div class="row">
            <h2>Recent Orders:</h2>
          
            <div class="OrderTable">
              <table id="ordersList">
                <tr class="table_header">
                  <th>Order Number</th>
                  <th width = "150%">Items</th>
                  <th>Status</th>
                
                </tr>
                <!-- <tr>
                  <td>69420</td>
                  <td>Tylenol x1 <br> Iburprofen x2 <br> Rubbing Alcohol x3</td>
                  <td>Not Delivered</td>
                  
                </tr>
                <tr>
                  <td>69421</td>
                  <td>Iburprofen x1</td>
                  <td>Processing</td>
                </tr>
                <tr>
                  <td>69422</td>
                  <td>Viagra x1</td>
                  <td>Delivered</td>
                </tr> -->
              </table>
            </div>
      </div>

      <div class="row">
        <h2>Recent Prescriptions:</h2>
      
        <div class="OrderTable">
          <table id="prescriptionList">
            <tr class="table_header second">
              <th>Prescription ID</th>
              <th width = "150%">Items</th>
              <th>Prescriber</th>
              <th>Approval Status</th>
            
            </tr>
            <!-- <tr>
              <td>42069</td>
              <td>Tylenol x1 <br> Iburprofen x2 <br> Rubbing Alcohol x3</td>
              <td>Dr. Ravi</td>
              <td>Approved</td>
              
            </tr>
            <tr>
              <td>42070</td>
              <td>Iburprofen x1</td>
              <td>Dr. Jeff</td>
              <td>Pending</td>
            </tr>
            <tr>
              <td>42071</td>
              <td>Viagra x1</td>
              <td>Dr. Mayank</td>
              <td>Denied</td>
            </tr> -->
          </table>
        </div>
  </div>
        </section>
      </div>


      <!---PAYMENT INFORMATION-->
      <div id="payment-info" class="info-container">
        <section id="info" class="DrugFo">
          <div class="row">
            <h2>Saved Card Info:</h2>
          
            <div class="OrderTable">
              <table id="paymentList">
                <tr class="table_header">
                  <th style="width: 20%;">Name on Card</th>
                  <th style="width: 30%;">Card Number</th>
                  <th style="width: 40%;">Billing Address</th>
                  <th style="width: 10%;">Expiration Date</th>
                  <th>Remove</th>
                
                </tr>
                
              </table>
            </div>
      </div>
          <div class="paymentRow">
            <div class="row">
              <div class="col-75">
                <div class="container">
                  <form onsubmit = "return false">
            
                    <div class="row">
                      <div class="col-50">
                        <h3>Billing Address</h3>
                        <label for="fname"><i class="fa fa-user"></i> Full Name</label>
                        <input type="text" id="fname" name="firstname" placeholder="John M. Doe" required>
                        <label for="email"><i class="fa fa-envelope"></i> Email</label>
                        <input type="email" id="email" name="email" placeholder="john@example.com" required>
                        <label for="adr"><i class="fa fa-address-card-o"></i> Address</label>
                        <input type="text" id="adr" name="address" placeholder="542 W. 15th Street" required>
                        <label for="city"><i class="fa fa-institution"></i> City</label>
                        <input type="text" id="city" name="city" placeholder="New York" required>
            
                        <div class="row">
                          <div class="col-50">
                            <label for="state">State</label>
                            <input type="text" id="state" name="state" placeholder="NY" required>
                          </div>
                          <div class="col-50">
                            <label for="zip">Zip</label>
                            <input type="text" id="zip" name="zip" placeholder="10001" required>
                          </div>
                        </div>
                      </div>
            
                      <div class="col-50">
                        <h3>Payment</h3>
                        <label for="fname">Accepted Cards</label>
                        <div class="icon-container">
                          <i class="fa fa-cc-visa" style="color:navy;"></i>
                          <i class="fa fa-cc-amex" style="color:blue;"></i>
                          <i class="fa fa-cc-mastercard" style="color:red;"></i>
                          <i class="fa fa-cc-discover" style="color:orange;"></i>
                        </div>
                        <label for="cname">Name on Card</label>
                        <input type="text" id="cname" name="cardname" placeholder="John More Doe" required>
                        <label for="ccnum">Credit card number</label>
                        <input type="text" id="ccnum" name="cardnumber" placeholder="1111 2222 3333 4444" required>
                        <label for="expmonth">Exp Month</label>
                        <input type="text" id="expmonth" name="expmonth" placeholder="September" required>
            
                        <div class="row">
                          <div class="col-50">
                            <label for="expyear">Exp Year</label>
                            <input type="text" id="expyear" name="expyear" placeholder="2018" required>
                          </div>
                          <div class="col-50">
                            <label for="cvv">CVV</label>
                            <input type="text" id="cvv" name="cvv" placeholder="352" minlength ="3" maxlength="4" required>
                          </div>
                        </div>
                      </div>
            
                    </div>
                    <button  class="btn btnDash" onclick = "addCard()"> Add Card Information </button>
                  </form>
                </div>
              </div>
          </div>
        </section>
      </div>

      
      <!---SETTINGS INFORMATION-->
      <div id="settings-info" class="info-container">
        <section id="info" class="DrugFo">
          
            <div class="row">
              <h2>Settings:</h2>
              <div class="settingsCol colDash">
                
                <div class="settingRow">
                  <h3>Dark Mode</h3>
                  <label class="switch">
                    <input type="checkbox">
                    <span class="slider round"></span>
                  </label>
                </div>

                <hr class="dashTable" />
                
                <div class="settingRow">
                  <h3>Send Emails</h3>
                  <label class="switch">
                    <input type="checkbox">
                    <span class="slider round"></span>
                  </label>
                </div> 

                <hr class="dashTable" /> 

                <div class="settingRow">
                  <h3>Add Email Address</h3>
                  <button class="log-btn add" ><body>Add</body></button>
                </div>
                
                <hr class="dashTable"/>

                <div class="settingRow">
                  <h3>Delete Account</h3>
                  <button class="log-btn delete" onclick = 'deleteAccount()'><body>Delete</body></button>
              </div>

              </div>
    
            </div>
          
        </section>
      </div>

      <!---PRESCRIPTION APPROVAL INFORMATION-->
      <div id="approval-info" class="info-container">
        <section id="info" class="DrugFo">
          
            <div class="row">
              <h2>This is the placeholder for the approval section.</h2>
            </div>
  
        </section>
      </div>


    </div>
  </body>

  <script>
    async function logout() {
      console.log("Leaving the webpage");
      var user_record = JSON.parse(localStorage.getItem("User Record"));
      
      //Write updated User Record to Database
      let response = await fetch('/update/user', {
        method: 'PATCH',
        body: JSON.stringify({
          uid: user_record["uid"],
          phoneNumber: user_record.phoneNumber,
          address: user_record["Address"]
        }),
        headers: {
          'Content-type': 'application/json; charset=UTF-8',
        },
      })

      localStorage.removeItem("User Record");
      window.location.href = "./logoutPage.html";
    }

    window.onload = async function () {
      loadProfile();
      //PORTION TO ADD SPECIAL FUNCTIONS TO DOCTOR ACCOUNTS
      if (localStorage.getItem("User Record") == null) {
        //
      } else {
        //USER RECORD DOES NOT HAVE AN ACCOUNT TYPE BEING LISTED IN THE JSON, FIX!!!!

        var user_record = JSON.parse(localStorage.getItem("User Record"));
        console.log(user_record);
        console.log("Account Type: " + user_record['Account Type']); 

        let response = await fetch('/get/prescriptions/user', {
          method: 'PATCH',
          body: JSON.stringify({
            uid: user_record["uid"]
          }),
          headers: {
            'Content-type': 'application/json; charset=UTF-8',
          },
        })
  
        let responseStatus = response.status;
        let prescriptions = await response.json()
        console.log("Response Status: " + responseStatus);
        console.log("Prescription Data Fetched: " + JSON.stringify(prescriptions));

        if (responseStatus == 200){
          for (var prescriptionNumber in prescriptions){
            var prescription = prescriptions[prescriptionNumber];
            addPrescription(prescriptionNumber, [prescription.medication], prescription.doctorFirstName + " " + prescription.doctorLastName, "Valid");
          }
        }

        let paymentCardResponse = await fetch(`/get/payment_cards?uid=${user_record['uid']}`)
        let paymentCardResponseJSON = await paymentCardResponse.json()

        console.log("Payment Card Response Status: " + paymentCardResponse.status);
        if (paymentCardResponse.status == 200){
          console.log("Payment Data Fetched: " + JSON.stringify(paymentCardResponseJSON));

          for (var paymentCardNumber in paymentCardResponseJSON){
            var paymentCard = paymentCardResponseJSON[paymentCardNumber]
            console.log("Payment Card: " + JSON.stringify(paymentCard));
            var name = paymentCard.name;

            var number = paymentCard.cardNumber;

            var address = paymentCard.address;
            var city = paymentCard.city;
            var state = paymentCard.state;
            var zip = paymentCard.zip;

            var expireM = paymentCard.expireM;
            var expireY = paymentCard.expireY;

            var rows = "<tr><td>"+name+"</td><td>"+number+"</td><td>"+address+", "+city+", "+state+", "+zip+"</td><td>"+expireM+" "+expireY+"</td></tr>";
            var table = document.getElementById("paymentList");
            var template = document.createElement('template');
            template.innerHTML = rows;
            table.append(template.content);
      
          }
        }

        //CURRENTLY APPLIES TO ALL ACCOUNTS. ONCE USER RECORD RETURNS ACCOUNT TYPE, REPLACE true WITH user_record.accountType == "Doctor"
        if(user_record["Account Type"] == "Doctor")
        {

          document.getElementById("loggingOut").remove();

          var rows = "<a id=\"approvalOption\"class=\"\"href=\"#\"onclick='swapDisplay(\"approval-info\", \"approvalOption\")'>Prescription Approval</a>";
          var menu = document.getElementById("sideMenu");
          var template = document.createElement('template');
          template.innerHTML = rows;
          
          menu.appendChild(template.content);

          rows = "<a id =\"loggingOut\" onclick=\"logout()\">Logout</a>";
          template.innerHTML = rows;
          menu.appendChild(template.content);
        }
      }
    };

    function loadProfile(){
      document.getElementById("interface").innerHTML =
        document.getElementById("profile-info").innerHTML;
      if (localStorage.getItem("User Record") == null) {
        //
      } else {
        var user_record = JSON.parse(localStorage.getItem("User Record"));
        var profilePicture = user_record.photoURL;
        
        document.getElementById("profile-pic").src = profilePicture;
        document.getElementById("welcome-text").innerHTML =
          user_record.displayName;
        document.getElementById("full-name").innerHTML =
          user_record.displayName;
        document.getElementById("email").innerHTML = user_record.email;   
        document.getElementById("address").innerHTML = user_record["Address"];
        document.getElementById("phone").innerHTML = user_record.phoneNumber;
      }

    }

    function swapDisplay(location, menuOption) {
      var links = document.getElementById("sideMenu").getElementsByTagName("a");
      for (i = 0; i < links.length; i++) {
        links[i].className = "";
      }
      document.getElementById("interface").innerHTML =
        document.getElementById(location).innerHTML;
      document.getElementById(menuOption).className = "active";

      if(menuOption == "infoOption")
        loadProfile();
    }

    async function removeInfo(x, number, uid){
      console.log(x);
      var row = document.getElementById("paymentList").rows[x]
      console.log(row);
      console.log(number);
      document.getElementById("paymentList").deleteRow(x);

      //DELETE CREDIT CARD FROM DATABASE
      let response = await fetch(`/delete/payment_card?cardNumber=${number}&uid=${uid}`, {
        method: 'DELETE',
      })

      console.log("Response Status: " + response.status);
      
    }

    //HELPER FUNCTION TO ADD ORDERS TO ORDER TABLE
    //Params: Integer (Order Number), Array of Strings (List of Items and Quanitity), String (Order Status)
    //Usage Example: addOrder(599212, ["Drug1 x2", "Drug2 x3"], "Delivered");
    function addOrder(OrderNumber, ItemList, Status){
      if(OrderNumber == null || ItemList == null || ItemList.length == 0||Status == null)
        return;
      
      else{
        var rows = '<tr><td>'+ String(OrderNumber) +'</td><td>';
          size = ItemList.length;
          for(i = 0; i < size; i++){
            rows = rows+(ItemList[i]);
            
            if(i != (size-1))
            rows= rows+ ( "<br>");
          }
          rows= rows +( '</td><td>'+Status+'</td></tr>');
          var table = document.getElementById('ordersList');
          var template = document.createElement('template');
          template.innerHTML = rows;
          console.log(rows);
          table.append(template.content);
          
          return;
      }
      
      
    }
  
    //HELPER FUNCTION TO ADD PRESCRIPTIONS TO PRESCRIPTION TABLE
    //Params: Integer (Prescription Number), Array of Strings (List of Items and Quanitity), String (Name of Prescriber), String (Approval Status)
    //Usage Example: addOrder(599212, ["Drug1 x2", "Drug2 x3"], "Dr. Doctor","Delivered");
    function addPrescription(PrescriptionNumber, ItemList, PrescriberName, Approval){
      if(PrescriptionNumber == null || ItemList == null || ItemList.length == 0||PrescriberName == null || Approval == null)
        return;
      
      else{
        var rows = '<tr><td>'+ String(PrescriptionNumber) +'</td><td>';
          size = ItemList.length;
          for(i = 0; i < size; i++){
            rows = rows+(ItemList[i]);
            
            if(i != (size-1))
            rows= rows+ ( "<br>");
          }
          rows= rows +( '</td><td>'+PrescriberName+'</td><td>'+Approval+'</td></tr>');
          var table = document.getElementById('prescriptionList');
          var template = document.createElement('template');
          template.innerHTML = rows;
          console.log(rows);
          table.append(template.content);
          
          return;
      }
    }

    async function addCard(){
      document.getElementById("cvv").setCustomValidity("");


      var fname = document.getElementById("fname").value;
      var user_record = JSON.parse(localStorage.getItem("User Record"));
      var uid = user_record["uid"];
      var name = document.getElementById("cname").value;
      var email = document.getElementById("email").value;

      var number = document.getElementById("ccnum").value;

      var address = document.getElementById("adr").value;
      var city = document.getElementById("city").value;
      var state = document.getElementById("state").value;
      var zip = document.getElementById("zip").value;

      var expireM = document.getElementById("expmonth").value;
      var expireY = document.getElementById("expyear").value;
      var cvv = document.getElementById("cvv").value;



      //Validate State
      var States = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
      if(state==null || !States.includes(state)){
        alert("Please Enter a Valid State!");
        return false;
      }

    //Validate Zip Code      
    regex = new RegExp(/^[0-9]{5}$/);
      if(zip == null || regex.test(zip)==false){
        alert("Please enter a valid Zip Code!");
      return false;
      }
      //Test Validation for Credit Card Number (checks for a sequence of at least 12 numbers)
      number = number.replace(/\s/g, '');
      regex = new RegExp(/^[0-9]{12,19}$/);
      if(number == null || regex.test(number) == false){
        alert("Enter a valid Credit Card Number!");
        return false;
      }

      //Test Validation for Month
      var Months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      if(expireM== null || !Months.includes(expireM))
      {
        alert("Please Enter a valid Month!");
        return false;
      }

      //Test Validation for Year (Checks for four digits right now)
      regex = new RegExp(/^[0-9]{4}$/);
      if(expireY == null || regex.test(expireY)==false){
        alert("Please enter a valid Year!");
      return false;
      }

      //Test Validation for CVV
      regex = new RegExp(/^[0-9]{3,4}$/);
      if(cvv == null || regex.test(cvv)==false){
        alert("Please enter a valid CVV!");
      return false;
      }

      var rows = "<tr><td>"+name+"</td><td>---- ---- ---- "+number.substring(number.length-4)+"</td><td>"+address+", "+city+", "+state+", "+zip+"</td><td>"+expireM+" "+expireY+`</td><td><i class=\"fa fa-trash\" style=\"cursor: pointer;\" onclick  = \"removeInfo(this.parentNode.parentNode.rowIndex, ${number}, '${uid}')\"></i></td></tr>`;
      var table = document.getElementById("paymentList");
      var template = document.createElement('template');
      template.innerHTML = rows;
      table.append(template.content);

      var paymentInformation = {"uid" : user_record.uid, "name": name, "cardNumber": number, "address": address, "city": city, "state": state, "zip": zip, "expireM": expireM, "expireY": expireY,  "expirationDate": `${expireM}/${expireY}`, "cvv": cvv}
      
      let response = await fetch('/add/payment_card', {
        method: 'PATCH',
        body: JSON.stringify(paymentInformation),
        headers: {
          'Content-type': 'application/json; charset=UTF-8',
        },
      })

      return false;
    }
    async function addressChange(){
      var user_record = JSON.parse(localStorage.getItem("User Record"));
      var text = prompt("Address: ", document.getElementById("address").innerText);
      if(text){
        document.getElementById("address").innerText = text;
        user_record['Address'] = text;
        let response = await fetch('/update/user', {
          method: 'PATCH',
          body: JSON.stringify({
            uid: user_record["uid"],
            phoneNumber: user_record.phoneNumber,
            address: user_record["Address"]
          }),
          headers: {
            'Content-type': 'application/json; charset=UTF-8',
          },
        })
      }
      else{

      }

      localStorage.setItem("User Record", JSON.stringify(user_record));
    }
    async function phoneNumberChange(){
      var user_record = JSON.parse(localStorage.getItem("User Record"));
      let text = prompt("Phone: ", document.getElementById("phone").innerText);
      if(text){
        document.getElementById("phone").innerText = text;
        user_record.phoneNumber = text;

        let response = await fetch('/update/user', {
          method: 'PATCH',
          body: JSON.stringify({
            uid: user_record["uid"],
            phoneNumber: user_record.phoneNumber,
            address: user_record["Address"]
          }),
          headers: {
            'Content-type': 'application/json; charset=UTF-8',
          },
        })
      }
      else{
        
      }

      localStorage.setItem("User Record", JSON.stringify(user_record));
    }

    async function deleteAccount(){
      var user_record = JSON.parse(localStorage.getItem("User Record"));
      var uid = user_record.uid;

      //DELETE User Account FROM DATABASE
      let response = await fetch(`/delete/account?uid=${uid}`, {
        method: 'DELETE',
      })

      console.log("Response Status: " + response.status);
      localStorage.removeItem("User Record");
      window.location.href = "./logoutPage.html";
    }

    addOrder(69423, ["Viagra x1", "Iburprofen x2"], "Delivered");
  </script>
</html>
