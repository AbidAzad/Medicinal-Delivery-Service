<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Login</title>
    <link rel="stylesheet" href="./user-registration-form.css">

</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script type = "module">
        document.getElementById("register-button").addEventListener('click', function(){
            var email = document.getElementById("email").value
            var data = {
                email: email
            }
            fetch("/register", {
                method: 'POST', 
                cache: 'no-cache', 
                headers:{
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then( (response) => {
                if (response.status == 200){
                    response.text().then(text => {
                        var originalText = CryptoJS.AES.decrypt(text, "UserRecord").toString(CryptoJS.enc.Utf8);
                        var userRecord = JSON.parse(originalText);
                        if (typeof(Storage) != "undefined"){
                            localStorage.setItem("User Record", JSON.stringify(userRecord))
                            window.location.href = "waiting-for-validation.html";
                        }
                        else{
                            console.log("This Browser doesn't support local client side storage")
                        }
                    })
                }
            })
        })

        function handleCredentialResponse(response) {
          var data = {
            JWT: response.credential
          };
          
          fetch("/authenticate/google", {
            method: 'POST', // *GET, POST, PUT, DELETE, etc.
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data) // body data type must match "Content-Type" header
          })
          .then( (response) => {
            if (response.status == 200){
                response.text().then(text => {
                    var originalText = CryptoJS.AES.decrypt(text, "UserRecord").toString(CryptoJS.enc.Utf8);
                    var userRecord = JSON.parse(originalText);
                    if (typeof(Storage) != "undefined"){
                        localStorage.setItem("User Record", JSON.stringify(userRecord))
                    }
                    else{
                        console.log("This Browser doesn't support local client side storage")
                    }

                    window.location.href = "./homepage.html";
                })
            }
          }
          );
        }

        window.onload = function () {
          var client_id = "";
          fetch("/credentials/google", {
            method: "GET",
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then((response) => {
            if (response.status == 200){
              response.json().then(json => {
                client_id = CryptoJS.AES.decrypt(json.client_id, "SWE-Spring-2023").toString(CryptoJS.enc.Utf8)
                google.accounts.id.initialize({
                    client_id: `${client_id}`,
                    callback: handleCredentialResponse
                });
                google.accounts.id.renderButton(
                    document.getElementById("google-login"),
                    { theme: "outline", size: "large" , shape: "pill", width: 350, theme: "filled_blue"}  // customization attributes
                );
                google.accounts.id.prompt(); // also display the One Tap dialog
              })
            }
          })

        }
    </script>

    <div class = "bg-img"></div>

    <form>
        <div class="user-auth-form-field">
            <input id = "email" type="email" placeholder="Email" required/>
        </div>
    
        <div class="user-auth-form-field">
            <input type="password" placeholder="Password" required/>                         
        </div>
    
        <div class="user-auth-form-field">
            <button id = "register-button" class="register-button">Register</button>
        </div>
        <div class = "google-login" id ="google-login"></div>
    </form>
  
</body>
</html>
